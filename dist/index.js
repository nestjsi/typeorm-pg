"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("typeorm");function sha1Triplet(e,t,n,r){return e<20?t&n|~t&r:e<40?t^n^r:e<60?t&n|t&r|n&r:t^n^r}function addSafe(e,t){const n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n}function bitwiseRotateToLeft(e,t){return e<<t|e>>>32-t}function sha1OfRawString(e){return function bigEndianToString(e){let t="";for(let n=0;n<32*e.length;n+=8)t+=String.fromCharCode(e[n>>5]>>>24-n%32&255);return t}(function bigEndianToSha1(e,t){e[t>>5]|=128<<24-t%32,e[15+(t+64>>9<<4)]=t;const n=Array(80);let r=1732584193,i=-271733879,a=-1732584194,o=271733878,s=-1009589776;for(let t=0;t<e.length;t+=16){const u=r,c=i,m=a,p=o,g=s;for(let u=0;u<80;u+=1){n[u]=u<16?e[t+u]:bitwiseRotateToLeft(n[u-3]^n[u-8]^n[u-14]^n[u-16],1);const c=addSafe(addSafe(bitwiseRotateToLeft(r,5),sha1Triplet(u,i,a,o)),addSafe(addSafe(s,n[u]),(l=u)<20?1518500249:l<40?1859775393:l<60?-1894007588:-899497514));s=o,o=a,a=bitwiseRotateToLeft(i,30),i=r,r=c}r=addSafe(r,u),i=addSafe(i,c),a=addSafe(a,m),o=addSafe(o,p),s=addSafe(s,g)}var l;return Array(r,i,a,o,s)}(function rawStringToBigEndian(e){let t=Array(e.length>>2);for(let e=0;e<t.length;e+=1)t[e]=0;for(let n=0;n<8*e.length;n+=8)t[n>>5]|=(255&e.charCodeAt(n/8))<<24-n%32;return t}(e),8*e.length))}function cryptSha1(e){return function rawStringToHexString(e){let t,n="";for(let r=0;r<e.length;r+=1)t=e.charCodeAt(r),n+="0123456789abcdef".charAt(t>>>4&15)+"0123456789abcdef".charAt(15&t);return n}(sha1OfRawString(function stringToRawUtf8String(e){let t,n,r="",i=-1;for(;++i<e.length;)t=e.charCodeAt(i),n=i+1<e.length?e.charCodeAt(i+1):0,55296<=t&&t<=56319&&56320<=n&&n<=57343&&(t=65536+((1023&t)<<10)+(1023&n),i+=1),t<=127?r+=String.fromCharCode(t):t<=2047?r+=String.fromCharCode(192|t>>>6&31,128|63&t):t<=65535?r+=String.fromCharCode(224|t>>>12&15,128|t>>>6&63,128|63&t):t<=2097151&&(r+=String.fromCharCode(240|t>>>18&7,128|t>>>12&63,128|t>>>6&63,128|63&t));return r}(e)))}function stripSchema(e,t=!0){let n=e.trim().normalize("NFC");if(!n.includes("."))return n;if(t&&n.startsWith("public."))return n.substr(7);const r=n.split(".");return 2!==r.length?n:r[1]}function stripPublic(e,t=!0){let n=e.trim().normalize("NFC");return t?stripSchema(e,!0):n}function textCaseCamel(e,t=!1){return e.replace(/^([A-Z])|[\s-_](\w)/g,(function(e,n,r,i){return!0===t&&0===i?n:r?r.toUpperCase():n.toLowerCase()}))}function textCaseSnake(e){return e.replace(/(?:([a-z])([A-Z]))|(?:((?!^)[A-Z])([a-z]))/g,"$1_$3$2$4").toLowerCase()}function safeConstraint(e,t="_",n="__"){if(e.length<64){const r=e.trim().split(n),i=r.pop().split(t).map(textCaseSnake),a=`${r.join(n)}${n}${i.join(t)}`;return a.length<64?a:e}const r=e.trim().split(n),i=[...r].pop(),a=i.split(t).map(textCaseSnake).map(e=>e.endsWith("_id")||e.endsWith("_ref")?e.substring(0,e.length-3):e.endsWith("_uuid")?e.substring(0,e.length-5):e),o=r.join(n);{const e=`${o}${a.join(t)}`;if(e.length<64)return e}{const e=`${o}${a.map(e=>textCaseCamel(e)).join(t)}`;if(e.length<64)return e}{const e=`${o}${a.map(e=>textCaseCamel(e)).join(t)}`;if(e.length<64)return e}{const e=`${o}${cryptSha1(i)}`;if(e.length<64)return e}{const e=`${r.shift()}${n}${cryptSha1(r.join(n)+i)}`;if(e.length<64)return e}return cryptSha1(e)}class SafeNamingStrategy extends e.DefaultNamingStrategy{constructor(){super(...arguments),this.name="SafeNamingStrategy"}foreignKeyName(e,t,n,r,i="FK",a=!0,o=!0){const s=stripPublic(String(e),a),l=stripPublic(n||"",a),u=t.reduce((e,t)=>`${stripPublic(e,a)}__${stripPublic(t,a)}`,`${s}__${l}`),c=63-i.length+2;if(u.length>c){if(o){const e=t.reduce((e,t)=>"_"+stripPublic(t,a),"");if(e.length<=c)return safeConstraint(`${i}_${e}`)}return safeConstraint(`${i}__${cryptSha1(u)}`)}return safeConstraint(`${i}__${u}`)}relationConstraintName(e,t,n="REL",r=!0,i=!0){const a=stripPublic(String(e),r),o=63-n.length,s=t.map(e=>stripPublic(e,r)).join("_"),l=`${n}__${a}__${s}`;if(l.length>o){if(i){const e=`${n}__${s}`;if(e.length<=o)return safeConstraint(e)}return safeConstraint(`${n}__${cryptSha1(l)}`)}return safeConstraint(l)}indexName(e,t,n,r="IDX",i=!0,a=!0){let o=stripPublic(String(e),i);const s=63-r.length,l=t.map(e=>stripPublic(e,i)).join("_"),u=`${r}__${o}__${l}`;if(u.length>s){if(a){const e=`${r}__${l}`;if(e.length<=s)return safeConstraint(e)}return safeConstraint(`${r}__${cryptSha1(u)}`)}return safeConstraint(u)}}var t,n,r;(t=exports.ColumnPrimaryType||(exports.ColumnPrimaryType={})).BigInteger="bigint",t.Decimal="decimal",t.Integer="integer",t.SmallInteger="smallint",t.UUID="uuid",(n=exports.ColumnType||(exports.ColumnType={})).BigInteger="bigint",n.Bit="bit",n.BitVarying="bit varying",n.Bool="bool",n.Boolean="boolean",n.Box="box",n.ByteHexadecimal="bytea",n.CIText="citext",n.Char="char",n.Character="character",n.CharacterVarying="character varying",n.Circle="circle",n.Cube="cube",n.Date="date",n.DateRange="daterange",n.Decimal="decimal",n.DoublePrecision="double precision",n.Enum="enum",n.Float="float",n.Float4="float4",n.Float8="float8",n.Geography="geography",n.Geometry="geometry",n.HStore="hstore",n.IPAddress="inet",n.IPCIDR="cidr",n.Int="int",n.Int2="int2",n.Int4="int4",n.Int4Range="int4range",n.Int8="int8",n.Int8Range="int8range",n.Integer="integer",n.Interval="interval",n.JSON="json",n.JSONB="jsonb",n.LabelTrees="ltree",n.Line="line",n.LineSegment="lseg",n.MACAddress="macaddr",n.Money="money",n.NumberRange="numrange",n.Numeric="numeric",n.Path="path",n.Point="point",n.Polygon="polygon",n.Real="real",n.SmallInteger="smallint",n.String="character varying",n.Text="text",n.TextSearchQuery="tsquery",n.TextSearchVector="tsvector",n.Time="time",n.TimeStamp="timestamp",n.TimeStampWithTimeZoneAbbr="timestamptz",n.TimeStampWithTimeZoneRange="tstzrange",n.TimeStampWithoutTimeZone="timestamp without time zone",n.TimeStampWithoutTimeZoneRange="tsrange",n.TimeWithTimeZoneAbbr="timetz",n.TimeWithTimeZone="time with time zone",n.TimeWithoutTimeZone="time without time zone",n.TimeStampWithTimeZone="timestamp with time zone",n.UUID="uuid",n.VariableBitString="varbit",n.VariableChar="varchar",n.XML="xml",(r=exports.ConstLength||(exports.ConstLength={}))[r.EmailMax=254]="EmailMax",r[r.EmailMin=6]="EmailMin",r[r.NameMax=99]="NameMax",r[r.NameMin=1]="NameMin",r[r.PassMax=128]="PassMax",r[r.PassMin=5]="PassMin";function safeIndex(e,t="IDX",n="_",r="__"){return safeConstraint(`${t}${r}${e.join(n)}`,n,r)}function safeUnique(e,t="UQ",n="_",r="__"){return safeConstraint(`${t}${r}${e.join(n)}`,n,r)}exports.Checks=function Checks(t,n){let r,i;if("string"==typeof t||t instanceof String?n?(r=t,i=n):i=t:Array.isArray(t)?i=t:"object"==typeof t&&("name"in t&&(r=t.name),"expressions"in t&&(i=t.expressions)),!i||0===i.length)throw new Error(`Check expressions is required âžœ ${JSON.stringify(t)}, ${JSON.stringify(n)}`);return Array.isArray(i)||(i=[i]),i=i.map(e=>((e=e.trim()).endsWith(";")&&(e=e.substring(0,e.length-1)),e)).join(" AND "),function EntityChecksDecorator(t,n){e.getMetadataArgsStorage().checks.push({target:n?t.constructor:t,name:r,expression:i})}},exports.ColumnOptionsExtra={comment:"Extra data in JSON format",default:{},name:"extra",nullable:!1,type:"json"},exports.EMAIL_LENGTH_MAX=254,exports.EMAIL_LENGTH_MIN=6,exports.IndexColumns=function IndexColumns(t){return e.Index(safeIndex(t),t)},exports.MANY_TO_MANY_OPTION_DEFAULT={eager:!0},exports.MANY_TO_ONE_OPTION_DEFAULT={eager:!0,onDelete:"RESTRICT",onUpdate:"CASCADE"},exports.NAME_LENGTH_MAX=99,exports.NAME_LENGTH_MIN=1,exports.ONE_TO_ONE_OPTION_DEFAULT={eager:!0,onDelete:"CASCADE",onUpdate:"CASCADE"},exports.PASSWORD_LENGTH_MAX=128,exports.PASSWORD_LENGTH_MIN=5,exports.PGSQL_BIG_INTEGER_MAX="9223372036854775807",exports.PGSQL_BIG_INTEGER_MIN="-9223372036854775808",exports.PGSQL_INTEGER_MAX=2147483647,exports.PGSQL_INTEGER_MIN=-2147483648,exports.PGSQL_NUMERIC_MAX="3141592653589793238462643383279502.1618033988749894848204586834365638",exports.PGSQL_NUMERIC_MIN="-3141592653589793238462643383279502.1618033988749894848204586834365638",exports.PGSQL_SMALL_INTEGER_MAX=32767,exports.PGSQL_SMALL_INTEGER_MIN=-32768,exports.SafeNamingStrategy=SafeNamingStrategy,exports.UniqueColumns=function UniqueColumns(t){return e.Unique(safeUnique(t),t)},exports.cryptSha1=cryptSha1,exports.safeConstraint=safeConstraint,exports.safeIndex=safeIndex,exports.safeUnique=safeUnique,exports.stripPublic=stripPublic,exports.stripSchema=stripSchema;
//# sourceMappingURL=index.js.map
