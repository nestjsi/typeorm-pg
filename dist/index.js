"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("typeorm");function sha1Triplet(t,e,n,r){return t<20?e&n|~e&r:t<40?e^n^r:t<60?e&n|e&r|n&r:e^n^r}function addSafe(t,e){const n=(65535&t)+(65535&e);return(t>>16)+(e>>16)+(n>>16)<<16|65535&n}function bitwiseRotateToLeft(t,e){return t<<e|t>>>32-e}function sha1OfRawString(t){return function bigEndianToString(t){let e="";for(let n=0;n<32*t.length;n+=8)e+=String.fromCharCode(t[n>>5]>>>24-n%32&255);return e}(function bigEndianToSha1(t,e){t[e>>5]|=128<<24-e%32,t[15+(e+64>>9<<4)]=e;const n=Array(80);let r=1732584193,i=-271733879,a=-1732584194,o=271733878,s=-1009589776;for(let e=0;e<t.length;e+=16){const u=r,c=i,m=a,p=o,g=s;for(let u=0;u<80;u+=1){n[u]=u<16?t[e+u]:bitwiseRotateToLeft(n[u-3]^n[u-8]^n[u-14]^n[u-16],1);const c=addSafe(addSafe(bitwiseRotateToLeft(r,5),sha1Triplet(u,i,a,o)),addSafe(addSafe(s,n[u]),(l=u)<20?1518500249:l<40?1859775393:l<60?-1894007588:-899497514));s=o,o=a,a=bitwiseRotateToLeft(i,30),i=r,r=c}r=addSafe(r,u),i=addSafe(i,c),a=addSafe(a,m),o=addSafe(o,p),s=addSafe(s,g)}var l;return Array(r,i,a,o,s)}(function rawStringToBigEndian(t){let e=Array(t.length>>2);for(let t=0;t<e.length;t+=1)e[t]=0;for(let n=0;n<8*t.length;n+=8)e[n>>5]|=(255&t.charCodeAt(n/8))<<24-n%32;return e}(t),8*t.length))}function cryptSha1(t){return function rawStringToHexString(t){let e,n="";for(let r=0;r<t.length;r+=1)e=t.charCodeAt(r),n+="0123456789abcdef".charAt(e>>>4&15)+"0123456789abcdef".charAt(15&e);return n}(sha1OfRawString(function stringToRawUtf8String(t){let e,n,r="",i=-1;for(;++i<t.length;)e=t.charCodeAt(i),n=i+1<t.length?t.charCodeAt(i+1):0,55296<=e&&e<=56319&&56320<=n&&n<=57343&&(e=65536+((1023&e)<<10)+(1023&n),i+=1),e<=127?r+=String.fromCharCode(e):e<=2047?r+=String.fromCharCode(192|e>>>6&31,128|63&e):e<=65535?r+=String.fromCharCode(224|e>>>12&15,128|e>>>6&63,128|63&e):e<=2097151&&(r+=String.fromCharCode(240|e>>>18&7,128|e>>>12&63,128|e>>>6&63,128|63&e));return r}(t)))}function stripSchema(t,e=!0){let n=t.trim().normalize("NFC");if(!n.includes("."))return n;if(e&&n.startsWith("public."))return n.substr(7);const r=n.split(".");return 2!==r.length?n:r[1]}function stripPublic(t,e=!0){let n=t.trim().normalize("NFC");return e?stripSchema(t,!0):n}function textCaseCamel(t,e=!1){return t.replace(/^([A-Z])|[\s-_](\w)/g,(function(t,n,r,i){return!0===e&&0===i?n:r?r.toUpperCase():n.toLowerCase()}))}function textCaseSnake(t){return t.replace(/(?:([a-z])([A-Z]))|(?:((?!^)[A-Z])([a-z]))/g,"$1_$3$2$4").toLowerCase()}function safeConstraint(t,e="_",n="__"){if(t.length<64){const r=t.trim().split(n),i=r.pop().split(e).map(textCaseSnake),a=`${r.join(n)}${n}${i.join(e)}`;return a.length<64?a:t}const r=t.trim().split(n),i=[...r].pop(),a=i.split(e).map(textCaseSnake).map(t=>t.endsWith("_id")||t.endsWith("_ref")?t.substring(0,t.length-3):t.endsWith("_uuid")?t.substring(0,t.length-5):t),o=r.join(n);{const t=`${o}${a.join(e)}`;if(t.length<64)return t}{const t=`${o}${a.map(t=>textCaseCamel(t)).join(e)}`;if(t.length<64)return t}{const t=`${o}${a.map(t=>textCaseCamel(t)).join(e)}`;if(t.length<64)return t}{const t=`${o}${cryptSha1(i)}`;if(t.length<64)return t}{const t=`${r.shift()}${n}${cryptSha1(r.join(n)+i)}`;if(t.length<64)return t}return cryptSha1(t)}class SafeNamingStrategy extends t.DefaultNamingStrategy{constructor(){super(...arguments),this.name="SafeNamingStrategy"}indexName(t,e,n,r="IDX",i=!0,a=!0){let o=stripPublic(String(t),i);const s=63-r.length,l=e.map(t=>stripPublic(t,i)).join("_"),u=`${r}__${o}__${l}`;if(u.length>s){if(a){const t=`${r}__${l}`;if(t.length<=s)return safeConstraint(t)}return safeConstraint(`${r}__${cryptSha1(u)}`)}return safeConstraint(u)}foreignKeyName(t,e,n,r,i="FK",a=!0,o=!0){const s=stripPublic(String(t),a),l=stripPublic(n||"",a),u=e.reduce((t,e)=>`${stripPublic(t,a)}__${stripPublic(e,a)}`,`${s}__${l}`),c=63-i.length+2;if(u.length>c){if(o){const t=e.reduce((t,e)=>"_"+stripPublic(e,a),"");if(t.length<=c)return safeConstraint(`${i}_${t}`)}return safeConstraint(`${i}__${cryptSha1(u)}`)}return safeConstraint(`${i}__${u}`)}primaryKeyName(t,e,n="PK",r=!0,i=!0){let a=stripPublic(String(t),r);const o=63-n.length,s=e.map(t=>stripPublic(t,r)).join("_"),l=`${n}__${a}__${s}`;if(l.length>o){if(i){const t=`${n}__${s}`;if(t.length<=o)return safeConstraint(t)}return safeConstraint(`${n}__${cryptSha1(l)}`)}return safeConstraint(l)}relationConstraintName(t,e,n="REL",r=!0,i=!0){const a=stripPublic(String(t),r),o=63-n.length,s=e.map(t=>stripPublic(t,r)).join("_"),l=`${n}__${a}__${s}`;if(l.length>o){if(i){const t=`${n}__${s}`;if(t.length<=o)return safeConstraint(t)}return safeConstraint(`${n}__${cryptSha1(l)}`)}return safeConstraint(l)}}var e,n,r;(e=exports.ColumnPrimaryType||(exports.ColumnPrimaryType={})).BigInteger="bigint",e.Decimal="decimal",e.Integer="integer",e.SmallInteger="smallint",e.UUID="uuid",(n=exports.ColumnType||(exports.ColumnType={})).BigInteger="bigint",n.Bit="bit",n.BitVarying="bit varying",n.Bool="bool",n.Boolean="boolean",n.Box="box",n.ByteHexadecimal="bytea",n.CIText="citext",n.Char="char",n.Character="character",n.CharacterVarying="character varying",n.Circle="circle",n.Cube="cube",n.Date="date",n.DateRange="daterange",n.Decimal="decimal",n.DoublePrecision="double precision",n.Enum="enum",n.Float="float",n.Float4="float4",n.Float8="float8",n.Geography="geography",n.Geometry="geometry",n.HStore="hstore",n.IPAddress="inet",n.IPCIDR="cidr",n.Int="int",n.Int2="int2",n.Int4="int4",n.Int4Range="int4range",n.Int8="int8",n.Int8Range="int8range",n.Integer="integer",n.Interval="interval",n.JSON="json",n.JSONB="jsonb",n.LabelTrees="ltree",n.Line="line",n.LineSegment="lseg",n.MACAddress="macaddr",n.Money="money",n.NumberRange="numrange",n.Numeric="numeric",n.Path="path",n.Point="point",n.Polygon="polygon",n.Real="real",n.SmallInteger="smallint",n.String="character varying",n.Text="text",n.TextSearchQuery="tsquery",n.TextSearchVector="tsvector",n.Time="time",n.TimeStamp="timestamp",n.TimeStampWithTimeZoneAbbr="timestamptz",n.TimeStampWithTimeZoneRange="tstzrange",n.TimeStampWithoutTimeZone="timestamp without time zone",n.TimeStampWithoutTimeZoneRange="tsrange",n.TimeWithTimeZoneAbbr="timetz",n.TimeWithTimeZone="time with time zone",n.TimeWithoutTimeZone="time without time zone",n.TimeStampWithTimeZone="timestamp with time zone",n.UUID="uuid",n.VariableBitString="varbit",n.VariableChar="varchar",n.XML="xml",(r=exports.ConstLength||(exports.ConstLength={}))[r.EmailMax=254]="EmailMax",r[r.EmailMin=6]="EmailMin",r[r.NameMax=99]="NameMax",r[r.NameMin=1]="NameMin",r[r.PassMax=128]="PassMax",r[r.PassMin=5]="PassMin";function safeIndex(t,e="IDX",n="_",r="__"){return safeConstraint(`${e}${r}${t.join(n)}`,n,r)}function safeUnique(t,e="UQ",n="_",r="__"){return safeConstraint(`${e}${r}${t.join(n)}`,n,r)}exports.Checks=function Checks(e,n){let r,i;if("string"==typeof e||e instanceof String?n?(r=e,i=n):i=e:Array.isArray(e)?i=e:"object"==typeof e&&("name"in e&&(r=e.name),"expressions"in e&&(i=e.expressions)),!i||0===i.length)throw new Error(`Check expressions is required âžœ ${JSON.stringify(e)}, ${JSON.stringify(n)}`);return Array.isArray(i)||(i=[i]),i=i.map(t=>((t=t.trim()).endsWith(";")&&(t=t.substring(0,t.length-1)),t)).join(" AND "),function EntityChecksDecorator(e,n){t.getMetadataArgsStorage().checks.push({target:n?e.constructor:e,name:r,expression:i})}},exports.ColumnOptionsExtra={comment:"Extra data in JSON format",default:{},name:"extra",nullable:!1,type:"json"},exports.EMAIL_LENGTH_MAX=254,exports.EMAIL_LENGTH_MIN=6,exports.IndexColumns=function IndexColumns(e){return t.Index(safeIndex(e),e)},exports.MANY_TO_MANY_OPTION_DEFAULT={eager:!0},exports.MANY_TO_ONE_OPTION_DEFAULT={eager:!0,onDelete:"RESTRICT",onUpdate:"CASCADE"},exports.NAME_LENGTH_MAX=99,exports.NAME_LENGTH_MIN=1,exports.ONE_TO_ONE_OPTION_DEFAULT={eager:!0,onDelete:"CASCADE",onUpdate:"CASCADE"},exports.PASSWORD_LENGTH_MAX=128,exports.PASSWORD_LENGTH_MIN=5,exports.PGSQL_BIG_INTEGER_MAX="9223372036854775807",exports.PGSQL_BIG_INTEGER_MIN="-9223372036854775808",exports.PGSQL_INTEGER_MAX=2147483647,exports.PGSQL_INTEGER_MIN=-2147483648,exports.PGSQL_NUMERIC_MAX="3141592653589793238462643383279502.1618033988749894848204586834365638",exports.PGSQL_NUMERIC_MIN="-3141592653589793238462643383279502.1618033988749894848204586834365638",exports.PGSQL_SMALL_INTEGER_MAX=32767,exports.PGSQL_SMALL_INTEGER_MIN=-32768,exports.SafeNamingStrategy=SafeNamingStrategy,exports.UniqueColumns=function UniqueColumns(e){return t.Unique(safeUnique(e),e)},exports.cryptSha1=cryptSha1,exports.safeConstraint=safeConstraint,exports.safeIndex=safeIndex,exports.safeUnique=safeUnique,exports.stripPublic=stripPublic,exports.stripSchema=stripSchema;
//# sourceMappingURL=index.js.map
